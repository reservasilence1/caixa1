<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pagamento PIX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f5f4;--card:#fff;--borda:#e8ebea;--verde:#42761d;--txt:#1f2a1e;--sub:#6b776a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt)}
    .wrapper{max-width:560px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--borda);border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:18px}
    .titulo{font-weight:800;text-align:center;margin:6px 0 2px}
    .sub{font-size:13px;color:var(--sub);text-align:center;margin-bottom:12px}
    .qrWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .qr{width:260px;height:260px;border-radius:12px;border:1px solid #ecf0ec;object-fit:contain;background:#fff}
    .valor{font-weight:800;font-size:18px;color:#111;text-align:center;margin-top:4px}
    .pixBox{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f7faf6;border:1px dashed #d7e4d3;border-radius:10px;padding:10px;word-break:break-all;width:100%}
    .btns{display:flex;gap:8px;width:100%}
    .btn{flex:1;height:46px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .btn.copy{background:#fff;border:2px solid var(--verde);color:var(--verde)}
    .btn.ok{background:var(--verde);color:#fff}
    .info{font-size:13px;color:var(--sub);text-align:center;margin-top:8px;line-height:1.5}
    .rodape{display:flex;justify-content:center;margin-top:14px}
    .rodape img{height:70px;opacity:.85}
    .ref{font-size:12px;color:#777;text-align:center;margin-top:8px}
    .status{margin-top:10px;font-size:13px;color:#555;text-align:center}
    .headerTopo{background:#fff;padding:12px 0;border-bottom:1px solid #e5e7eb}
    .headerWrap{max-width:880px;margin:0 auto;padding:0 16px;display:flex;justify-content:space-between;align-items:center}
    .headerLogo{height:35px}
    .btnMinhas{padding:10px 22px;border-radius:999px;border:2px solid #1d4ed8;background:#fff;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;color:#1d4ed8}
    .loader{
      width:18px;height:18px;border-radius:999px;border:3px solid rgba(66,118,29,.25);
      border-top-color: var(--verde); animation: spin 1s linear infinite; display:inline-block; vertical-align:middle;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<!-- Pixel Utmify -->
<script>
  window.pixelId = "693cab59f3b93a26dfc078ad";
  var a = document.createElement("script");
  a.setAttribute("async", "");
  a.setAttribute("defer", "");
  a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
  document.head.appendChild(a);
</script>

<script
  src="https://cdn.utmify.com.br/scripts/utms/latest.js"
  data-utmify-prevent-xcod-sck
  data-utmify-prevent-subids
  async
  defer
></script>

<div class="wrapper">
  <header class="headerTopo">
    <div class="headerWrap">
      <!-- Se seu payment.html está em /chat/vsl/payment.html, mantenha images/ dentro de /chat/vsl/images/ -->
      <img src="images/logo.png" class="headerLogo" alt="Logo">
      <button id="btnMinhas" class="btnMinhas" type="button">Minhas compras</button>
    </div>
  </header>

  <div class="card">
    <div class="titulo">Pagamento via Pix</div>
    <div id="nomeLinha" class="sub"></div>

    <div class="qrWrap">
      <img id="qrImg" class="qr" alt="QR Code Pix">
      <div id="valorLinha" class="valor"></div>
      <div id="pixCode" class="pixBox"></div>

      <div class="btns">
        <button id="copiar" class="btn copy" type="button">Copiar código</button>
        <button id="paguei" class="btn ok" type="button">Já paguei</button>
      </div>

      <div class="info">
        Abra o app do seu banco, escolha <b>Pix</b>, selecione <b>Pix Copia e Cola</b>
        e cole o código acima ou escaneie o QR Code.
      </div>

      <div id="refLinha" class="ref"></div>
      <div id="statusLinha" class="status"></div>
    </div>
  </div>

  <div class="rodape"><img src="images/logo.png" alt="Logo"></div>
</div>

<script>
  function brl(v){
    const n = Number(v || 0);
    return "R$ " + n.toFixed(2).replace(".", ",");
  }
  function toCentsFromValor(valorStr){
    const raw = String(valorStr || "").replace(",", ".").replace(/[^0-9.]/g, "");
    const v = Number(raw || 0);
    return Math.round(v * 100);
  }
  function maskCpf(c){
    const d = String(c || "").replace(/\D/g,"");
    if (d.length < 5) return c || "";
    return d.slice(0,3) + ".***.***-" + d.slice(-2);
  }
  function ensureDataUriBase64(maybeBase64){
    if (!maybeBase64) return "";
    if (/^data:image\//i.test(maybeBase64)) return maybeBase64;
    if (/^[A-Za-z0-9+/=]+$/.test(maybeBase64)) return "data:image/png;base64," + maybeBase64;
    return maybeBase64;
  }
  function setQrFromPixCode(pixCode){
    const url = "https://api.qrserver.com/v1/create-qr-code/?size=420x420&data=" + encodeURIComponent(pixCode);
    document.getElementById("qrImg").src = url;
  }

  // --------- PEGAR DADOS DO FUNIL ----------
  const dadosUsuarioRaw = localStorage.getItem("dadosUsuario");
  if (!dadosUsuarioRaw) {
    // volta para o index da pasta atual
    window.location.href = "index.html";
  }

  let dadosUsuario = {};
  try { dadosUsuario = JSON.parse(dadosUsuarioRaw || "{}"); } catch(e) {}

  const nome = (dadosUsuario?.nome || "").toString().replace(/\+/g," ").trim();
  const cpf  = (dadosUsuario?.cpf  || "").toString().replace(/\D/g,"");

  const nomeCurto = nome ? nome.split(" ").slice(0,2).join(" ") : "";
  document.getElementById("nomeLinha").textContent =
    (nomeCurto && cpf) ? (nomeCurto + " • CPF " + maskCpf(cpf)) : (nomeCurto || "");

  // --------- PARAMS / VALOR ----------
  const urlParams = new URLSearchParams(window.location.search);

  // Pode vir "valor=32.80" e/ou "amount=3280"
  const valorParam = urlParams.get("valor");
  const amountParam = urlParams.get("amount"); // centavos

  let amountCents = 0;
  if (amountParam && /^\d+$/.test(amountParam)) {
    amountCents = Number(amountParam);
  } else if (valorParam) {
    amountCents = toCentsFromValor(valorParam);
  } else {
    // fallback (se não vier na url)
    amountCents = 3280;
  }

  const valorReais = (amountCents / 100);
  document.getElementById("valorLinha").textContent = brl(valorReais);

  // requestNumber
  let requestNumber = urlParams.get("requestNumber");
  if (!requestNumber) {
    requestNumber = (crypto?.randomUUID ? crypto.randomUUID() : ("req_" + Date.now() + "_" + Math.floor(Math.random()*1e6)));
    urlParams.set("requestNumber", requestNumber);
    // mantém a URL bonitinha sem recarregar
    history.replaceState(null, "", window.location.pathname + "?" + urlParams.toString());
  }

  // --------- ELEMENTOS UI ----------
  const qrImgEl = document.getElementById("qrImg");
  const pixCodeEl = document.getElementById("pixCode");
  const refEl = document.getElementById("refLinha");
  const statusEl = document.getElementById("statusLinha");

  function setLoading(msg){
    statusEl.innerHTML = '<span class="loader"></span>' + (msg || "Gerando Pix...");
  }

  function setStatus(msg){
    statusEl.textContent = msg || "";
  }

  // --------- GERAR PIX NA VERSELL (via sua API serverless) ----------
  async function gerarPixVersell(){
    setLoading("Gerando Pix...");

    // Monta payload no padrão Versell (o serverless /api/versell-qrcode deve completar/validar)
    const payload = {
      requestNumber: requestNumber,
      amount: amountCents, // centavos (recomendado)
      callbackUrl: (window.location.origin + "/api/versell-webhook"), // ajuste se quiser outro
      client: {
        name: nome || "Cliente",
        document: cpf || "00000000000",
        phoneNumber: "11999999999",
        email: "cliente@email.com",
        address: {
          codIbge: "3550308",
          street: "Rua Exemplo",
          number: "100",
          complement: "",
          zipCode: "01001000",
          neighborhood: "Centro",
          city: "São Paulo",
          state: "SP"
        }
      },
      products: [
        { description: "Taxa de ativação", quantity: 1, value: amountCents }
      ]
    };

    try {
      const r = await fetch("/api/versell-qrcode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        cache: "no-store",
        body: JSON.stringify(payload)
      });

      const data = await r.json().catch(() => null);

      if (!r.ok) {
        const errMsg = (data && (data.error || data.message)) ? (data.error || data.message) : ("Erro ao gerar Pix (" + r.status + ")");
        setStatus(errMsg);
        return null;
      }

      // Esperado (Versell):
      // { idTransaction, paymentCode, paymentCodeBase64, response }
      const idTransaction = data?.idTransaction || data?.data?.idTransaction || null;
      const paymentCode = data?.paymentCode || data?.data?.paymentCode || "";
      const paymentCodeBase64 = data?.paymentCodeBase64 || data?.data?.paymentCodeBase64 || "";

      if (!paymentCode && !paymentCodeBase64) {
        setStatus("Pix não retornou código. Tente novamente.");
        return null;
      }

      // Salva para reabrir a página sem perder
      localStorage.setItem("versell_pix", JSON.stringify({
        idTransaction,
        paymentCode,
        paymentCodeBase64,
        requestNumber,
        amountCents
      }));

      renderPix({ idTransaction, paymentCode, paymentCodeBase64 });
      setStatus("Status: aguardando pagamento...");
      return { idTransaction, paymentCode, paymentCodeBase64 };
    } catch (e) {
      setStatus("Falha ao gerar Pix. Verifique sua API /api/versell-qrcode.");
      return null;
    }
  }

  function renderPix({ idTransaction, paymentCode, paymentCodeBase64 }){
    // Copia e cola
    pixCodeEl.textContent = paymentCode || "Código Pix indisponível.";

    // QR
    const qrFixed = ensureDataUriBase64(paymentCodeBase64);
    if (qrFixed) {
      qrImgEl.src = qrFixed;
    } else if (paymentCode) {
      setQrFromPixCode(paymentCode);
    } else {
      qrImgEl.removeAttribute("src");
    }

    // Referência
    if (idTransaction) {
      refEl.textContent = "Referência: " + idTransaction;
      localStorage.setItem("versell_tx", idTransaction);
    } else {
      refEl.textContent = "";
    }
  }

  // --------- STATUS (via sua API serverless) ----------
  let checking = false;

  async function checarStatus(){
    if (checking) return;
    const tx = localStorage.getItem("versell_tx");
    if (!tx) {
      setStatus("Status: aguardando referência da transação...");
      return;
    }

    checking = true;
    try {
      const r = await fetch("/api/versell-status?id=" + encodeURIComponent(tx), { cache: "no-store" });
      const s = await r.json().catch(() => null);

      // Esperado: { statusTransaction: "PAID_OUT" | ... } ou { status: ... }
      const st = String(s?.statusTransaction || s?.status || "").toUpperCase();

      if (st) setStatus("Status: " + st);
      else if (s?.error) setStatus("Status: " + s.error);
      else setStatus("Status: aguardando confirmação...");

      // ✅ Pago na Versell normalmente: PAID_OUT
      if (st === "PAID_OUT" || st === "LIQUIDATED") {
        window.location.href = "sucesso.html";
      }
    } catch(e){
      // silencioso (não trava UX)
    } finally {
      checking = false;
    }
  }

  // --------- BOTÕES ----------
  document.getElementById("copiar").addEventListener("click", async () => {
    const pixSaved = localStorage.getItem("versell_pix");
    let paymentCode = "";
    try { paymentCode = JSON.parse(pixSaved || "{}")?.paymentCode || ""; } catch(e){}
    paymentCode = paymentCode || pixCodeEl.textContent || "";

    if (!paymentCode) { alert("Código Pix não encontrado."); return; }

    try {
      await navigator.clipboard.writeText(paymentCode);
      alert("Código Pix copiado!");
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = paymentCode;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("Código Pix copiado!");
    }
  });

  document.getElementById("paguei").addEventListener("click", checarStatus);

  document.getElementById("btnMinhas").addEventListener("click", () => {
    window.location.href = "sucesso.html";
  });

  // --------- BOOT: tenta carregar do localStorage, senão gera ----------
  (async function init(){
    // Se já existe pix salvo, reaproveita (evita gerar outro)
    const cached = localStorage.getItem("versell_pix");
    if (cached) {
      try {
        const obj = JSON.parse(cached);
        if (obj?.paymentCode || obj?.paymentCodeBase64) {
          // garante consistência com o requestNumber atual
          renderPix({
            idTransaction: obj.idTransaction,
            paymentCode: obj.paymentCode,
            paymentCodeBase64: obj.paymentCodeBase64
          });
          setStatus("Status: aguardando pagamento...");
        } else {
          await gerarPixVersell();
        }
      } catch(e){
        await gerarPixVersell();
      }
    } else {
      await gerarPixVersell();
    }

    // auto-check
    checarStatus();
    setInterval(checarStatus, 4000);
  })();
</script>

</body>
</html>
