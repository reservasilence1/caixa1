<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pagamento PIX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f5f4;--card:#fff;--borda:#e8ebea;--verde:#42761d;--txt:#1f2a1e;--sub:#6b776a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt)}
    .wrapper{max-width:560px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--borda);border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:18px}
    .titulo{font-weight:800;text-align:center;margin:6px 0 2px}
    .sub{font-size:13px;color:var(--sub);text-align:center;margin-bottom:12px}
    .qrWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .qr{width:260px;height:260px;border-radius:12px;border:1px solid #ecf0ec;object-fit:contain;background:#fff}
    .valor{font-weight:800;font-size:18px;color:#111;text-align:center;margin-top:4px}
    .pixBox{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f7faf6;border:1px dashed #d7e4d3;border-radius:10px;padding:10px;word-break:break-all;width:100%}
    .btns{display:flex;gap:8px;width:100%}
    .btn{flex:1;height:46px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .btn.copy{background:#fff;border:2px solid var(--verde);color:var(--verde)}
    .btn.ok{background:var(--verde);color:#fff}
    .info{font-size:13px;color:var(--sub);text-align:center;margin-top:8px;line-height:1.5}
    .rodape{display:flex;justify-content:center;margin-top:14px}
    .rodape img{height:70px;opacity:.85}
    .ref{font-size:12px;color:#777;text-align:center;margin-top:8px}
    .status{margin-top:10px;font-size:13px;color:#555;text-align:center}
    .headerTopo{background:#fff;padding:12px 0;border-bottom:1px solid #e5e7eb}
    .headerWrap{max-width:880px;margin:0 auto;padding:0 16px;display:flex;justify-content:space-between;align-items:center}
    .headerLogo{height:35px}
    .btnMinhas{padding:10px 22px;border-radius:999px;border:2px solid #1d4ed8;background:#fff;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;color:#1d4ed8}

    .debugBox{
      margin-top:12px;
      width:100%;
      border-radius:12px;
      border:1px solid #eee;
      background:#0b1220;
      color:#e5e7eb;
      padding:12px;
      font-family:ui-monospace, Menlo, Consolas, monospace;
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      display:none;
    }

    .loader{
      width:18px;height:18px;border-radius:999px;border:3px solid rgba(66,118,29,.25);
      border-top-color: var(--verde); animation: spin 1s linear infinite; display:inline-block; vertical-align:middle;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<!-- Pixel Utmify -->
<script>
  window.pixelId = "693cab59f3b93a26dfc078ad";
  var a = document.createElement("script");
  a.setAttribute("async", "");
  a.setAttribute("defer", "");
  a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
  document.head.appendChild(a);
</script>
<script
  src="https://cdn.utmify.com.br/scripts/utms/latest.js"
  data-utmify-prevent-xcod-sck
  data-utmify-prevent-subids
  async
  defer
></script>

<div class="wrapper">
  <header class="headerTopo">
    <div class="headerWrap">
      <!-- ⚠️ Se a logo 404, é porque o arquivo NÃO existe nesse caminho/ nome -->
      <img src="images/logo.png" class="headerLogo" alt="Logo">
      <button id="btnMinhas" class="btnMinhas" type="button">Minhas compras</button>
    </div>
  </header>

  <div class="card">
    <div class="titulo">Pagamento via Pix</div>
    <div id="nomeLinha" class="sub"></div>

    <div class="qrWrap">
      <img id="qrImg" class="qr" alt="QR Code Pix">
      <div id="valorLinha" class="valor"></div>
      <div id="pixCode" class="pixBox"></div>

      <div class="btns">
        <button id="copiar" class="btn copy" type="button">Copiar código</button>
        <button id="paguei" class="btn ok" type="button">Já paguei</button>
      </div>

      <div class="info">
        Abra o app do seu banco, escolha <b>Pix</b>, selecione <b>Pix Copia e Cola</b>
        e cole o código acima ou escaneie o QR Code.
      </div>

      <div id="refLinha" class="ref"></div>
      <div id="statusLinha" class="status"></div>
      <div id="debugBox" class="debugBox"></div>
    </div>
  </div>

  <div class="rodape"><img src="images/logo.png" alt="Logo"></div>
</div>

<script>
  function brl(v){
    const n = Number(v || 0);
    return "R$ " + n.toFixed(2).replace(".", ",");
  }
  function toCentsFromValor(valorStr){
    const raw = String(valorStr || "").replace(",", ".").replace(/[^0-9.]/g, "");
    const v = Number(raw || 0);
    return Math.round(v * 100);
  }
  function maskCpf(c){
    const d = String(c || "").replace(/\D/g,"");
    if (d.length < 5) return c || "";
    return d.slice(0,3) + ".***.***-" + d.slice(-2);
  }
  function ensureDataUriBase64(maybeBase64){
    if (!maybeBase64) return "";
    if (/^data:image\//i.test(maybeBase64)) return maybeBase64;
    if (/^[A-Za-z0-9+/=]+$/.test(maybeBase64)) return "data:image/png;base64," + maybeBase64;
    return maybeBase64;
  }
  function setQrFromPixCode(pixCode){
    const url = "https://api.qrserver.com/v1/create-qr-code/?size=420x420&data=" + encodeURIComponent(pixCode);
    document.getElementById("qrImg").src = url;
  }

  const qrImgEl = document.getElementById("qrImg");
  const pixCodeEl = document.getElementById("pixCode");
  const refEl = document.getElementById("refLinha");
  const statusEl = document.getElementById("statusLinha");
  const debugBox = document.getElementById("debugBox");

  function showDebug(obj){
    debugBox.style.display = "block";
    try { debugBox.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2); }
    catch(e){ debugBox.textContent = String(obj); }
  }
  function hideDebug(){
    debugBox.style.display = "none";
    debugBox.textContent = "";
  }

  function setLoading(msg){
    statusEl.innerHTML = '<span class="loader"></span>' + (msg || "Gerando Pix...");
  }
  function setStatus(msg){
    statusEl.textContent = msg || "";
  }

  // ---------- DADOS DO FUNIL ----------
  const dadosUsuarioRaw = localStorage.getItem("dadosUsuario");
  if (!dadosUsuarioRaw) window.location.href = "index.html";

  let dadosUsuario = {};
  try { dadosUsuario = JSON.parse(dadosUsuarioRaw || "{}"); } catch(e){}

  const nome = (dadosUsuario?.nome || "").toString().replace(/\+/g," ").trim();
  const cpf  = (dadosUsuario?.cpf  || "").toString().replace(/\D/g,"");

  const nomeCurto = nome ? nome.split(" ").slice(0,2).join(" ") : "";
  document.getElementById("nomeLinha").textContent =
    (nomeCurto && cpf) ? (nomeCurto + " • CPF " + maskCpf(cpf)) : (nomeCurto || "");

  // ---------- PARAMS / VALOR ----------
  const urlParams = new URLSearchParams(window.location.search);

  const valorParam = urlParams.get("valor");     // ex: 32.80
  const amountParam = urlParams.get("amount");   // ex: 3280 (centavos)

  let amountCents = 0;
  if (amountParam && /^\d+$/.test(amountParam)) amountCents = Number(amountParam);
  else if (valorParam) amountCents = toCentsFromValor(valorParam);
  else amountCents = 3280;

  const valorReais = (amountCents / 100);
  document.getElementById("valorLinha").textContent = brl(valorReais);

  let requestNumber = urlParams.get("requestNumber");
  if (!requestNumber) {
    requestNumber = (crypto?.randomUUID ? crypto.randomUUID() : ("req_" + Date.now() + "_" + Math.floor(Math.random()*1e6)));
    urlParams.set("requestNumber", requestNumber);
    history.replaceState(null, "", window.location.pathname + "?" + urlParams.toString());
  }

  // ---------- RENDER ----------
  function renderPix({ idTransaction, paymentCode, paymentCodeBase64 }){
    pixCodeEl.textContent = paymentCode || "Código Pix indisponível.";

    const qrFixed = ensureDataUriBase64(paymentCodeBase64);
    if (qrFixed) {
      qrImgEl.src = qrFixed;
    } else if (paymentCode) {
      setQrFromPixCode(paymentCode);
    } else {
      qrImgEl.removeAttribute("src");
    }

    if (idTransaction) {
      refEl.textContent = "Referência: " + idTransaction;
      localStorage.setItem("versell_tx", idTransaction);
    } else {
      refEl.textContent = "";
    }
  }

  // ---------- GERAR PIX (SERVERLESS) ----------
  function pickFirst(obj, paths){
    for (const p of paths){
      const parts = p.split(".");
      let cur = obj;
      let ok = true;
      for (const k of parts){
        if (cur && Object.prototype.hasOwnProperty.call(cur, k)) cur = cur[k];
        else { ok = false; break; }
      }
      if (ok && cur) return cur;
    }
    return "";
  }

  async function gerarPixVersell(){
    hideDebug();
    setLoading("Gerando Pix...");

    // Versell costuma aceitar amount em centavos, mas alguns setups usam reais.
    // Enviamos OS DOIS (se sua API não quiser, ela ignora um).
    const payload = {
      requestNumber,
      amount: amountCents,                  // centavos (3280)
      amountReais: Number(valorReais.toFixed(2)), // reais (32.80)
      callbackUrl: window.location.origin + "/api/versell-webhook",
      client: {
        name: nome || "Cliente",
        document: cpf || "00000000000",
        phoneNumber: "11999999999",
        email: "cliente@email.com",
        address: {
          codIbge: "3550308",
          street: "Rua Exemplo",
          number: "100",
          complement: "",
          zipCode: "01001000",
          neighborhood: "Centro",
          city: "São Paulo",
          state: "SP"
        }
      },
      products: [{ description: "Taxa de ativação", quantity: 1, value: amountCents }]
    };

    try {
      const r = await fetch("/api/versell-qrcode", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        cache: "no-store",
        body: JSON.stringify(payload)
      });

      const data = await r.json().catch(() => null);

      // ✅ se der erro, mostra na tela
      if (!r.ok) {
        setStatus("Erro ao gerar Pix (" + r.status + ")");
        showDebug({ httpStatus: r.status, response: data, sentPayload: payload });
        return null;
      }

      // ✅ tenta achar os campos em várias chaves possíveis
      const idTransaction =
        pickFirst(data, ["idTransaction","data.idTransaction","pix.idTransaction","response.idTransaction"]) || null;

      const paymentCode =
        pickFirst(data, [
          "paymentCode","data.paymentCode","pix.paymentCode","response.paymentCode",
          "payment_code","data.payment_code",
          "qrcode","data.qrcode","pix.qrcode",
          "pixCode","data.pixCode","pix.pixCode"
        ]) || "";

      const paymentCodeBase64 =
        pickFirst(data, [
          "paymentCodeBase64","data.paymentCodeBase64","pix.paymentCodeBase64","response.paymentCodeBase64",
          "qrcodeBase64","data.qrcodeBase64","pix.qrcodeBase64"
        ]) || "";

      if (!paymentCode && !paymentCodeBase64) {
        setStatus("API respondeu, mas não veio Pix (código/QR).");
        showDebug({ response: data, hint: "Confere o retorno do /api/versell-qrcode (chaves) e o amount enviado." });
        return null;
      }

      localStorage.setItem("versell_pix", JSON.stringify({
        idTransaction, paymentCode, paymentCodeBase64, requestNumber, amountCents
      }));

      renderPix({ idTransaction, paymentCode, paymentCodeBase64 });
      setStatus("Status: aguardando pagamento...");
      return { idTransaction, paymentCode, paymentCodeBase64 };
    } catch (e) {
      setStatus("Falha ao chamar /api/versell-qrcode");
      showDebug({ error: String(e), sentPayload: payload });
      return null;
    }
  }

  // ---------- STATUS ----------
  let checking = false;
  async function checarStatus(){
    if (checking) return;

    const tx = localStorage.getItem("versell_tx");
    if (!tx) {
      setStatus("Status: aguardando referência da transação...");
      return;
    }

    checking = true;
    try{
      const r = await fetch("/api/versell-status?id=" + encodeURIComponent(tx), { cache:"no-store" });
      const s = await r.json().catch(() => null);

      const st = String(s?.statusTransaction || s?.status || "").toUpperCase();

      if (st) setStatus("Status: " + st);
      else if (s?.error) setStatus("Status: " + s.error);
      else setStatus("Status: aguardando confirmação...");

      if (st === "PAID_OUT" || st === "LIQUIDATED") {
        window.location.href = "sucesso.html";
      }
    }catch(e){
      // silencioso
    }finally{
      checking = false;
    }
  }

  // ---------- BOTÕES ----------
  document.getElementById("copiar").addEventListener("click", async () => {
    let paymentCode = pixCodeEl.textContent || "";
    if (!paymentCode || /indisponível/i.test(paymentCode)) { alert("Código Pix não encontrado."); return; }

    try {
      await navigator.clipboard.writeText(paymentCode);
      alert("Código Pix copiado!");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = paymentCode;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("Código Pix copiado!");
    }
  });

  document.getElementById("paguei").addEventListener("click", checarStatus);
  document.getElementById("btnMinhas").addEventListener("click", () => window.location.href = "sucesso.html");

  // ---------- INIT ----------
  (async function init(){
    // reaproveita se já existe
    const cached = localStorage.getItem("versell_pix");
    if (cached) {
      try{
        const obj = JSON.parse(cached);
        if (obj?.paymentCode || obj?.paymentCodeBase64) {
          renderPix({ idTransaction: obj.idTransaction, paymentCode: obj.paymentCode, paymentCodeBase64: obj.paymentCodeBase64 });
          setStatus("Status: aguardando pagamento...");
        } else {
          await gerarPixVersell();
        }
      }catch{
        await gerarPixVersell();
      }
    } else {
      await gerarPixVersell();
    }

    checarStatus();
    setInterval(checarStatus, 4000);
  })();
</script>
</body>
</html>
