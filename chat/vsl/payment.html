<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pagamento PIX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f5f4;--card:#fff;--borda:#e8ebea;--verde:#42761d;--txt:#1f2a1e;--sub:#6b776a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt)}
    .wrapper{max-width:560px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--borda);border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:18px}
    .titulo{font-weight:800;text-align:center;margin:6px 0 2px}
    .sub{font-size:13px;color:var(--sub);text-align:center;margin-bottom:12px}
    .qrWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .qr{width:260px;height:260px;border-radius:12px;border:1px solid #ecf0ec;object-fit:contain;background:#fff}
    .valor{font-weight:800;font-size:18px;color:#111;text-align:center;margin-top:4px}
    .pixBox{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f7faf6;border:1px dashed #d7e4d3;border-radius:10px;padding:10px;word-break:break-all;width:100%}
    .btns{display:flex;gap:8px;width:100%}
    .btn{flex:1;height:46px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .btn.copy{background:#fff;border:2px solid var(--verde);color:var(--verde)}
    .btn.ok{background:var(--verde);color:#fff}
    .info{font-size:13px;color:var(--sub);text-align:center;margin-top:8px;line-height:1.5}
    .rodape{display:flex;justify-content:center;margin-top:14px}
    .rodape img{height:70px;opacity:.85}
    .ref{font-size:12px;color:#777;text-align:center;margin-top:8px}
    .status{margin-top:10px;font-size:13px;color:#555;text-align:center}
    .headerTopo{background:#fff;padding:12px 0;border-bottom:1px solid #e5e7eb}
    .headerWrap{max-width:880px;margin:0 auto;padding:0 16px;display:flex;justify-content:space-between;align-items:center}
    .headerLogo{height:35px}
    .btnMinhas{padding:10px 22px;border-radius:999px;border:2px solid #1d4ed8;background:#fff;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;color:#1d4ed8}
    .loader{
      width:18px;height:18px;border-radius:999px;border:3px solid rgba(66,118,29,.25);
      border-top-color: var(--verde); animation: spin 1s linear infinite; display:inline-block; vertical-align:middle;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<!-- Pixel Utmify -->
<script>
  window.pixelId = "693cab59f3b93a26dfc078ad";
  var a = document.createElement("script");
  a.setAttribute("async", "");
  a.setAttribute("defer", "");
  a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
  document.head.appendChild(a);
</script>

<script
  src="https://cdn.utmify.com.br/scripts/utms/latest.js"
  data-utmify-prevent-xcod-sck
  data-utmify-prevent-subids
  async
  defer
></script>

<div class="wrapper">
  <header class="headerTopo">
    <div class="headerWrap">
      <!-- Se seu payment.html está em /chat/vsl/payment.html, mantenha images/ dentro de /chat/vsl/images/ -->
      <img src="images/logo.png" class="headerLogo" alt="Logo">
      <button id="btnMinhas" class="btnMinhas" type="button">Minhas compras</button>
    </div>
  </header>

  <div class="card">
    <div class="titulo">Pagamento via Pix</div>
    <div id="nomeLinha" class="sub"></div>

    <div class="qrWrap">
      <img id="qrImg" class="qr" alt="QR Code Pix">
      <div id="valorLinha" class="valor"></div>
      <div id="pixCode" class="pixBox"></div>

      <div class="btns">
        <button id="copiar" class="btn copy" type="button">Copiar código</button>
        <button id="paguei" class="btn ok" type="button">Já paguei</button>
      </div>

      <div class="info">
        Abra o app do seu banco, escolha <b>Pix</b>, selecione <b>Pix Copia e Cola</b>
        e cole o código acima ou escaneie o QR Code.
      </div>

      <div id="refLinha" class="ref"></div>
      <div id="statusLinha" class="status"></div>
    </div>
  </div>

  <div class="rodape"><img src="images/logo.png" alt="Logo"></div>
</div>

<script>
  function brl(v){
    const n = Number(v || 0);
    return "R$ " + n.toFixed(2).replace(".", ",");
  }
  function toCentsFromValor(valorStr){
    const raw = String(valorStr || "").replace(",", ".").replace(/[^0-9.]/g, "");
    const v = Number(raw || 0);
    return Math.round(v * 100);
  }
  function maskCpf(c){
    const d = String(c || "").replace(/\D/g,"");
    if (d.length < 5) return c || "";
    return d.slice(0,3) + ".***.***-" + d.slice(-2);
  }
  function ensureDataUriBase64(maybeBase64){
    if (!maybeBase64) return "";
    if (/^data:image\//i.test(maybeBase64)) return maybeBase64;
    if (/^[A-Za-z0-9+/=]+$/.test(maybeBase64)) return "data:image/png;base64," + maybeBase64;
    return maybeBase64;
  }
  function setQrFromPixCode(pixCode){
    const url = "https://api.qrserver.com/v1/create-qr-code/?size=420x420&data=" + encodeURIComponent(pixCode);
    document.getElementById("qrImg").src = url;
  }

  // --------- PEGAR DADOS DO FUNIL ----------
  const dadosUsuarioRaw = localStorage.getItem("dadosUsuario");
  if (!dadosUsuarioRaw) {
    // volta para o index da pasta atual
    window.location.href = "index.html";
  }

  let dadosUsuario = {};
  try { dadosUsuario = JSON.parse(dadosUsuarioRaw || "{}"); } catch(e) {}

  const nome = (dadosUsuario?.nome || "").toString().replace(/\+/g," ").trim();
  const cpf  = (dadosUsuario?.cpf  || "").toString().replace(/\D/g,"");

  const nomeCurto = nome ? nome.split(" ").slice(0,2).join(" ") : "";
  document.getElementById("nomeLinha").textContent =
    (nomeCurto && cpf) ? (nomeCurto + " • CPF " + maskCpf(cpf)) : (nomeCurto || "");

  // --------- PARAMS / VALOR ----------
  const urlParams = new URLSearchParams(window.location.search);

  // Pode vir "valor=32.80" e/ou "amount=3280"
  const valorParam = urlParams.get("valor");
  const amountParam = urlParams.get("amount"); // centavos

  let amountCents = 0;
  if (amountParam && /^\d+$/.
