<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pagamento PIX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#f3f5f4;--card:#fff;--borda:#e8ebea;--verde:#42761d;--txt:#1f2a1e;--sub:#6b776a;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt)}
    .wrapper{max-width:560px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--borda);border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:18px}
    .titulo{font-weight:800;text-align:center;margin:6px 0 2px}
    .sub{font-size:13px;color:var(--sub);text-align:center;margin-bottom:12px}
    .qrWrap{display:flex;flex-direction:column;align-items:center;gap:12px}
    .qr{width:260px;height:260px;border-radius:12px;border:1px solid #ecf0ec;object-fit:contain;background:#fff}
    .valor{font-weight:800;font-size:18px;color:#111;text-align:center;margin-top:4px}
    .pixBox{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f7faf6;border:1px dashed #d7e4d3;border-radius:10px;padding:10px;word-break:break-all;width:100%}
    .btns{display:flex;gap:8px;width:100%}
    .btn{flex:1;height:46px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .btn.copy{background:#fff;border:2px solid var(--verde);color:var(--verde)}
    .btn.ok{background:var(--verde);color:#fff}
    .info{font-size:13px;color:var(--sub);text-align:center;margin-top:8px;line-height:1.5}
    .ref{font-size:12px;color:#777;text-align:center;margin-top:8px}
    .status{margin-top:10px;font-size:13px;color:#555;text-align:center}
    .debug{margin-top:10px;width:100%;padding:10px;border-radius:10px;background:#0b1220;color:#e5e7eb;font-size:12px;font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;display:none}
  </style>
</head>
<body>

<div class="wrapper">
  <div class="card">
    <div class="titulo">Pagamento via Pix</div>
    <div id="nomeLinha" class="sub"></div>

    <div class="qrWrap">
      <img id="qrImg" class="qr" alt="QR Code Pix">
      <div id="valorLinha" class="valor"></div>
      <div id="pixCode" class="pixBox">Gerando Pix...</div>

      <div class="btns">
        <button id="copiar" class="btn copy" type="button">Copiar código</button>
        <button id="paguei" class="btn ok" type="button">Já paguei</button>
      </div>

      <div class="info">
        Abra o app do seu banco, escolha <b>Pix</b>, selecione <b>Pix Copia e Cola</b>
        e cole o código acima ou escaneie o QR Code.
      </div>

      <div id="refLinha" class="ref"></div>
      <div id="statusLinha" class="status"></div>
      <div id="debug" class="debug"></div>
    </div>
  </div>
</div>

<script>
  function brl(v){ return "R$ " + Number(v||0).toFixed(2).replace(".", ","); }
  function onlyDigits(v){ return String(v||"").replace(/\D/g,""); }
  function maskCpf(c){
    const d = onlyDigits(c);
    if (d.length < 5) return c || "";
    return d.slice(0,3) + ".***.***-" + d.slice(-2);
  }
  function ensureDataUriBase64(maybeBase64){
    if (!maybeBase64) return "";
    if (/^data:image\//i.test(maybeBase64)) return maybeBase64;
    if (/^[A-Za-z0-9+/=]+$/.test(maybeBase64)) return "data:image/png;base64," + maybeBase64;
    return maybeBase64;
  }
  function setQrFromPixCode(pixCode){
    document.getElementById("qrImg").src =
      "https://api.qrserver.com/v1/create-qr-code/?size=420x420&data=" + encodeURIComponent(pixCode);
  }
  function showDebug(obj){
    const el = document.getElementById("debug");
    el.style.display = "block";
    el.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }

  const pixCodeEl = document.getElementById("pixCode");
  const refEl = document.getElementById("refLinha");
  const statusEl = document.getElementById("statusLinha");

  // dados do funil
  const dadosUsuarioRaw = localStorage.getItem("dadosUsuario");
  const dadosUsuario = dadosUsuarioRaw ? JSON.parse(dadosUsuarioRaw) : null;
  if (!dadosUsuario) location.href = "index.html";

  const nome = (dadosUsuario?.nome || "").toString().replace(/\+/g," ").trim();
  const cpf  = onlyDigits(dadosUsuario?.cpf || "");
  document.getElementById("nomeLinha").textContent =
    (nome && cpf) ? (nome.split(" ").slice(0,2).join(" ") + " • CPF " + maskCpf(cpf)) : (nome || "");

  // params vindos da VSL
  const p = new URLSearchParams(location.search);
  const valor = p.get("valor") || "32.80";
  const amount = p.get("amount") || "3280"; // pode vir centavos
  let requestNumber = p.get("requestNumber");
  if (!requestNumber) {
    requestNumber = (crypto?.randomUUID ? crypto.randomUUID() : ("req_"+Date.now()+"_"+Math.floor(Math.random()*1e6)));
    p.set("requestNumber", requestNumber);
    history.replaceState(null,"",location.pathname+"?"+p.toString());
  }

  // mostra valor
  const amountNum = Number(amount);
  const valorReais = (Number.isFinite(amountNum) && Number.isInteger(amountNum) && amountNum >= 1000)
    ? (amountNum/100) : Number(valor);
  document.getElementById("valorLinha").textContent = brl(valorReais);

  async function gerarPix(){
    // Sempre zera cache anterior ao gerar um novo Pix
    localStorage.removeItem("versell_tx");
    localStorage.removeItem("versell_pix");
    statusEl.textContent = "Status: gerando Pix...";
    try{
      const payload = {
        requestNumber,
        amount: amount, // ✅ pode mandar 3280 ou 32.80 — a API ajusta
        client: {
          name: nome || "Cliente",
          document: cpf || "00000000000",
          phoneNumber: "11999999999",
          email: "cliente@email.com",
          address: {
            codIbge: "3550308",
            street: "Rua Exemplo",
            number: "100",
            complement: "",
            zipCode: "01001000",
            neighborhood: "Centro",
            city: "São Paulo",
            state: "SP"
          }
        },
        products: [{ description: "Taxa de ativação", quantity: 1, value: amount }]
      };

      const r = await fetch("/api/versell-qrcode", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
        cache: "no-store"
      });

      const data = await r.json().catch(()=>null);

      if (!r.ok) {
        pixCodeEl.textContent = "Erro ao gerar Pix.";
        statusEl.textContent = "Status: erro ("+r.status+")";
        showDebug({httpStatus:r.status, response:data, sent:payload});
        return null;
      }

      const idTransaction = data?.idTransaction || null;
      const paymentCode = data?.paymentCode || "";
      const paymentCodeBase64 = data?.paymentCodeBase64 || "";

      if (!paymentCode && !paymentCodeBase64) {
        pixCodeEl.textContent = "Pix não retornou código.";
        statusEl.textContent = "Status: sem código Pix";
        showDebug(data);
        return null;
      }

      localStorage.setItem("versell_pix", JSON.stringify(data));
      if (idTransaction) localStorage.setItem("versell_tx", idTransaction);

      pixCodeEl.textContent = paymentCode || "(código não disponível)";
      if (paymentCodeBase64) document.getElementById("qrImg").src = ensureDataUriBase64(paymentCodeBase64);
      else setQrFromPixCode(paymentCode);

      refEl.textContent = idTransaction ? ("Referência: "+idTransaction) : "";
      statusEl.textContent = "Status: aguardando pagamento...";
      return idTransaction;
    } catch(e){
      pixCodeEl.textContent = "Falha ao chamar API.";
      statusEl.textContent = "Status: falha";
      showDebug(String(e));
      return null;
    }
  }

  let checking=false;
  async function checarStatus(){
    if (checking) return;
    const tx = localStorage.getItem("versell_tx");
    const reqNum = requestNumber;
    if (!tx && !reqNum) return;

    checking=true;
    try{
      // Usa POST conforme a API espera
      const r = await fetch("/api/versell-status", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          ...(tx ? { idTransaction: tx } : {}),
          ...(reqNum ? { requestNumber: reqNum } : {})
        }),
        cache: "no-store"
      });

      // A API VersellPay sempre retorna 200, então não validamos r.ok
      // O importante é verificar o processingStatus dentro da resposta
      
      const s = await r.json().catch(()=>null);
      
      // Verifica se conseguiu parsear a resposta
      if (!s || typeof s !== "object") {
        console.warn("Resposta inválida da API:", s);
        return;
      }

      // O backend retorna 'status' que vem de processingStatus da API VersellPay
      const st = String(s?.status || "").trim().toUpperCase();
      
      // Verifica se tem um status válido
      if (!st || st === "UNKNOWN" || st === "NOT_FOUND") {
        if (st === "NOT_FOUND") {
          statusEl.textContent = "Status: Transação não encontrada";
        }
        return;
      }
      
      // Atualiza o status na tela
      statusEl.textContent = "Status: " + st;

      // CRÍTICO: Só redireciona se processingStatus === "PAID_OUT"
      // A API sempre retorna 200, então a validação é APENAS no status
      if (st === "PAID_OUT") {
        console.log("✅ Pagamento confirmado (PAID_OUT)! Limpando cache e redirecionando...");
        // evita reaproveitar cobrança em sequência
        localStorage.removeItem("versell_tx");
        localStorage.removeItem("versell_pix");
        // após o primeiro pagamento, segue para o upsell
        location.href = "/upsell1/index.html";
      } else {
        console.log("⏳ Status atual:", st, "- Aguardando pagamento...");
      }
    } catch(e) {
      console.error("Erro ao verificar status:", e);
    } finally {
      checking=false;
    }
  }

  // botões
  document.getElementById("copiar").addEventListener("click", async ()=>{
    const code = pixCodeEl.textContent.trim();
    if (!code || code.includes("Erro") || code.includes("Pix não")) return alert("Código Pix indisponível.");
    try { await navigator.clipboard.writeText(code); alert("Código Pix copiado!"); }
    catch { alert("Não foi possível copiar automaticamente. Selecione e copie manualmente."); }
  });

  document.getElementById("paguei").addEventListener("click", checarStatus);

  // init
  (async ()=>{
    const cached = localStorage.getItem("versell_pix");
    if (cached) {
      try{
        const data = JSON.parse(cached);
        if (data?.paymentCode || data?.paymentCodeBase64) {
          pixCodeEl.textContent = data.paymentCode || "(código não disponível)";
          if (data.paymentCodeBase64) document.getElementById("qrImg").src = ensureDataUriBase64(data.paymentCodeBase64);
          else setQrFromPixCode(data.paymentCode);
          if (data.idTransaction) {
            localStorage.setItem("versell_tx", data.idTransaction);
            refEl.textContent = "Referência: " + data.idTransaction;
          }
          statusEl.textContent = "Status: aguardando pagamento...";
        } else {
          await gerarPix();
        }
      } catch { await gerarPix(); }
    } else {
      await gerarPix();
    }

    checarStatus();
    setInterval(checarStatus, 4000);
  })();
</script>
</body>
</html>
